<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VNC Viewer</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/viewer.css">
    <style>
        /* é¡µé¢ç‰¹å®šçš„é¢å¤–æ ·å¼å¯ä»¥æ”¾åœ¨è¿™é‡Œ */
        /* é¡µé¢ç‰¹å®šçš„é¢å¤–æ ·å¼å·²ç§»åˆ° viewer.css */
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-left">
            <div class="status-badge">
                <span class="status-dot" id="sandbox-dot"></span>
                <span id="session-info">åŠ è½½ä¸­...</span>
            </div>
            <div class="status-badge">
                <span class="status-dot" id="vnc-dot"></span>
                <span id="vnc-status">VNC: è¿æ¥ä¸­</span>
            </div>
        </div>
        <div>
            <button onclick="location.href='/'">â† è¿”å›åˆ—è¡¨</button>
            <button id="btn-export">ğŸ“¥ å¯¼å‡ºæ—¥å¿—</button>
        </div>
    </div>
    
    <!-- ä¸»å†…å®¹åŒºï¼ˆå·¦å³åŒæ ï¼‰ -->
    <div class="main-container">
        <!-- å·¦æ ï¼šæ—¥å¿—é¢æ¿ -->
        <div class="left-panel">
            <div class="panel-header">
                <h3>ğŸ“‹ è¿è¡Œæ—¥å¿—</h3>
                <div class="log-controls">
                    <input type="text" id="log-search" placeholder="ğŸ” æœç´¢æ—¥å¿—...">
                    <button class="filter-btn active" data-level="all">å…¨éƒ¨</button>
                    <button class="filter-btn" data-level="THINKING">ğŸ’­</button>
                    <button class="filter-btn" data-level="ACTION">âš¡</button>
                    <button class="filter-btn" data-level="ERROR">âŒ</button>
                </div>
            </div>
            <div class="log-content" id="log-content">
                <!-- æ—¥å¿—æ¡ç›®å°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
            </div>
            <div class="log-footer">
                <div>
                    <button id="btn-pause">â¸ï¸ æš‚åœ</button>
                    <button id="btn-clear">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>
                <span id="log-count">0 æ¡æ—¥å¿—</span>
            </div>
        </div>
        
        <!-- å³æ ï¼šVNC é¢æ¿ -->
        <div class="right-panel">
            <div class="panel-header">
                <h3>ğŸ–¥ï¸ VNC å®æ—¶ç”»é¢</h3>
                <div>
                    <button id="btn-reconnect">ğŸ”„ é‡è¿</button>
                </div>
            </div>
            <div class="vnc-content">
                <div id="vnc-screen">
                    <div class="loading">æ­£åœ¨è¿æ¥ VNC...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // å¯¼å…¥ noVNC å’Œ ANSI è§£æå™¨
        import RFB from 'https://cdn.jsdelivr.net/gh/novnc/noVNC@v1.4.0/core/rfb.js';
        import { parseAnsiToHtml } from '/static/js/ansi-parser.js';
        
        const sessionId = location.pathname.split('/').pop();
        let logs = [];
        let filteredLogs = [];
        let currentFilter = 'all';
        let searchTerm = '';
        let isPaused = false;
        let autoScroll = true;
        let rfb = null;
        let ws = null;
        
        // è·å– Sandbox ä¿¡æ¯
        async function loadSessionInfo() {
            try {
                // âœ… ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„ API è·¯å¾„ (sandboxes å¤æ•°)
                const response = await fetch(`/api/sandboxes/${sessionId}`);
                const sandbox = await response.json();
                
                // âœ… ä¿®å¤ï¼šæ›´æ–°æ•°æ®ç»“æ„ï¼ˆåç«¯è¿”å›çš„æ˜¯ sandbox å¯¹è±¡ï¼Œä¸æ˜¯ data.sessionï¼‰
                document.getElementById('session-info').textContent = 
                    `Sandbox: ${sessionId.substring(0, 20)}...`;
                
                const sandboxDot = document.getElementById('sandbox-dot');
                // âœ… ä¿®å¤ï¼šæ£€æŸ¥ cdp_url æˆ– vnc_url æ˜¯å¦å­˜åœ¨æ¥åˆ¤æ–­åœ¨çº¿çŠ¶æ€
                if (sandbox.cdp_url || sandbox.vnc_url) {
                    sandboxDot.classList.add('online');
                } else {
                    sandboxDot.classList.remove('online');
                }
                
                return sandbox;
            } catch (error) {
                console.error('åŠ è½½ Sandbox ä¿¡æ¯å¤±è´¥:', error);
                return null;
            }
        }
        
        // è¿æ¥æ—¥å¿— WebSocket
        function connectLogWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/ws/log/${sessionId}`);
            
            ws.onopen = () => {
                console.log('æ—¥å¿— WebSocket å·²è¿æ¥');
            };
            
            ws.onmessage = (event) => {
                const log = JSON.parse(event.data);
                if (log.type === 'ping') return; // å¿½ç•¥å¿ƒè·³
                
                addLog(log);
            };
            
            ws.onerror = () => {
                console.error('æ—¥å¿— WebSocket é”™è¯¯');
            };
            
            ws.onclose = () => {
                console.log('æ—¥å¿— WebSocket å·²å…³é—­ï¼Œ3ç§’åé‡è¿...');
                setTimeout(connectLogWebSocket, 3000);
            };
            
            // å®šæœŸå‘é€å¿ƒè·³
            setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send('ping');
                }
            }, 20000);
        }
        
        // æ·»åŠ æ—¥å¿—
        function addLog(log) {
            if (isPaused) return;
            
            logs.push(log);
            
            if (matchesFilter(log)) {
                filteredLogs.push(log);
                renderLog(log);
                
                // è‡ªåŠ¨æ»šåŠ¨
                if (autoScroll) {
                    const container = document.getElementById('log-content');
                    container.scrollTop = container.scrollHeight;
                }
            }
            
            updateCount();
        }
        
        // æ£€æŸ¥æ˜¯å¦åŒ¹é…ç­›é€‰æ¡ä»¶
        function matchesFilter(log) {
            if (currentFilter !== 'all' && log.level !== currentFilter) {
                return false;
            }
            
            if (searchTerm && !log.message.toLowerCase().includes(searchTerm.toLowerCase())) {
                return false;
            }
            
            return true;
        }
        
        // æ¸²æŸ“å•æ¡æ—¥å¿—ï¼ˆæ”¯æŒ ANSI é¢œè‰²ï¼‰
        function renderLog(log) {
            const container = document.getElementById('log-content');
            const logEl = document.createElement('div');
            logEl.className = `log-entry log-${log.level.toLowerCase()}`;
            
            // âœ… ä¿®å¤ï¼šPython æ—¶é—´æˆ³æ˜¯ç§’ï¼ŒJavaScript éœ€è¦æ¯«ç§’
            const time = new Date(log.timestamp * 1000).toLocaleTimeString('zh-CN');
            
            // âœ… ä½¿ç”¨ ANSI è§£æå™¨æ¸²æŸ“æ¶ˆæ¯ï¼ˆæ”¯æŒé¢œè‰²ï¼‰
            const coloredMessage = parseAnsiToHtml(log.message);
            logEl.innerHTML = `<span class="log-time">${time}</span>${coloredMessage}`;
            
            container.appendChild(logEl);
        }
        
        // æ›´æ–°æ—¥å¿—è®¡æ•°
        function updateCount() {
            document.getElementById('log-count').textContent = `${filteredLogs.length} æ¡æ—¥å¿—`;
        }
        
        // é‡æ–°ç­›é€‰
        function refilter() {
            document.getElementById('log-content').innerHTML = '';
            filteredLogs = [];
            
            logs.forEach(log => {
                if (matchesFilter(log)) {
                    filteredLogs.push(log);
                    renderLog(log);
                }
            });
            
            updateCount();
        }
        
        // è¿æ¥ VNC
        async function connectVNC(vncUrl) {
            if (!vncUrl) {
                document.getElementById('vnc-screen').innerHTML = 
                    '<div class="loading">VNC URL æœªé…ç½®</div>';
                return;
            }
            
            try {
                document.getElementById('vnc-screen').innerHTML = '';
                rfb = new RFB(document.getElementById('vnc-screen'), vncUrl);
                
                rfb.addEventListener('connect', () => {
                    console.log('VNC å·²è¿æ¥');
                    document.getElementById('vnc-status').textContent = 'VNC: å·²è¿æ¥';
                    document.getElementById('vnc-dot').classList.add('online');
                });
                
                rfb.addEventListener('disconnect', (e) => {
                    console.log('VNC å·²æ–­å¼€');
                    document.getElementById('vnc-status').textContent = 'VNC: å·²æ–­å¼€';
                    document.getElementById('vnc-dot').classList.remove('online');
                    
                    if (!e.detail.clean) {
                        setTimeout(() => connectVNC(vncUrl), 3000);
                    }
                });
                
                rfb.scaleViewport = true;
                rfb.resizeSession = false;
                
            } catch (error) {
                console.error('VNC è¿æ¥å¤±è´¥:', error);
                document.getElementById('vnc-screen').innerHTML = 
                    '<div class="loading">VNC è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }
        
        // äº‹ä»¶ç»‘å®š
        document.getElementById('btn-pause').addEventListener('click', () => {
            isPaused = !isPaused;
            const btn = document.getElementById('btn-pause');
            btn.textContent = isPaused ? 'â–¶ï¸ ç»§ç»­' : 'â¸ï¸ æš‚åœ';
        });
        
        document.getElementById('btn-clear').addEventListener('click', () => {
            document.getElementById('log-content').innerHTML = '';
            logs = [];
            filteredLogs = [];
            updateCount();
        });
        
        document.getElementById('log-search').addEventListener('input', (e) => {
            searchTerm = e.target.value;
            refilter();
        });
        
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.level;
                refilter();
            });
        });
        
        document.getElementById('btn-reconnect').addEventListener('click', async () => {
            const session = await loadSessionInfo();
            if (session && session.vnc_url) {
                connectVNC(session.vnc_url);
            }
        });
        
        document.getElementById('btn-export').addEventListener('click', () => {
            const data = JSON.stringify(logs, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `logs_${sessionId}_${new Date().getTime()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });
        
        // åˆå§‹åŒ–
        (async () => {
            const session = await loadSessionInfo();
            connectLogWebSocket();
            
            if (session && session.vnc_url) {
                connectVNC(session.vnc_url);
            }
        })();
    </script>
</body>
</html>

