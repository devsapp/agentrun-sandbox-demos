<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentRun Sandbox VNC æŸ¥çœ‹å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .controls {
            padding: 8px 12px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .input-group label {
            font-weight: 600;
            color: #495057;
            font-size: 13px;
            white-space: nowrap;
        }

        .input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 13px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 6px;
        }

        button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #6c757d;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #28a745;
            animation: none;
        }

        .status-dot.connecting {
            background: #ffc107;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .vnc-container {
            position: relative;
            background: #000;
            flex: 1;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }

        #vnc-screen {
            width: 100%;
            height: 100%;
            position: relative;
            background: #000;
            display: block;
        }
        
        /* ç¡®ä¿ Canvas æ­£ç¡®æ˜¾ç¤º */
        #vnc-screen canvas {
            display: block;
            width: 100% !important;
            height: auto !important;
            max-width: 100%;
        }

        .loading {
            color: white;
            font-size: 18px;
            text-align: center;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <div class="input-group">
                <label for="vnc-url">VNC URL:</label>
                <input 
                    type="text" 
                    id="vnc-url" 
                    placeholder="wss://your-account-id.funagent-data-pre.cn-hangzhou.aliyuncs.com/sandboxes/xxx/ws/livestream"
                    value=""
                >
            </div>
            <div class="button-group">
                <button class="btn-primary" id="btn-connect">
                    ğŸ”— è¿æ¥
                </button>
                <button class="btn-secondary" id="btn-disconnect" disabled>
                    ğŸ”Œ æ–­å¼€
                </button>
                <button class="btn-success" id="btn-clear">
                    ğŸ—‘ï¸ æ¸…ç©º
                </button>
            </div>
            <div class="status" id="status">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">æœªè¿æ¥</span>
            </div>
        </div>

        <div class="vnc-container">
            <div id="vnc-screen" class="loading">
                <div>ç­‰å¾…è¿æ¥...</div>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨ CDN åŠ è½½ noVNC -->
    <script type="module">
        // åŠ¨æ€åŠ è½½ noVNC
        let RFB = null;
        let rfb = null;

        async function loadNoVNC() {
            try {
                // æ–¹æ³•1: å°è¯•ä» jsdelivr CDN åŠ è½½ï¼ˆä½¿ç”¨ GitHub ç‰ˆæœ¬ï¼‰
                console.log('ğŸ“¦ å°è¯•ä» CDN åŠ è½½ noVNC...');
                const module = await import('https://cdn.jsdelivr.net/gh/novnc/noVNC@v1.4.0/core/rfb.js');
                RFB = module.default || module.RFB || module;
                console.log('âœ… noVNC åŠ è½½æˆåŠŸï¼ŒRFB ç±»å‹:', typeof RFB);
                console.log('ğŸ“‹ RFB æ„é€ å‡½æ•°:', RFB);
                return true;
            } catch (error) {
                console.warn('âš ï¸ æ–¹æ³•1 å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2...', error);
                // æ–¹æ³•2: å°è¯•ä» npm CDN åŠ è½½
                try {
                    const module2 = await import('https://cdn.jsdelivr.net/npm/@novnc/novnc@1.4.0/core/rfb.js');
                    RFB = module2.default || module2.RFB || module2;
                    console.log('âœ… noVNC ä» npm CDN åŠ è½½æˆåŠŸ');
                    return true;
                } catch (e2) {
                    console.warn('âš ï¸ æ–¹æ³•2 å¤±è´¥ï¼Œå°è¯•æ–¹æ³•3...', e2);
                    // æ–¹æ³•3: ä½¿ç”¨åŠ¨æ€è„šæœ¬æ ‡ç­¾åŠ è½½
                    return new Promise((resolve) => {
                        const script = document.createElement('script');
                        script.type = 'module';
                        script.textContent = `
                            import RFB from 'https://cdn.jsdelivr.net/gh/novnc/noVNC@v1.4.0/core/rfb.js';
                            window.__noVNC_RFB = RFB;
                            window.dispatchEvent(new CustomEvent('novnc-loaded'));
                        `;
                        document.head.appendChild(script);
                        
                        const timeout = setTimeout(() => {
                            console.error('âŒ noVNC åŠ è½½è¶…æ—¶');
                            resolve(false);
                        }, 10000);
                        
                        window.addEventListener('novnc-loaded', () => {
                            clearTimeout(timeout);
                            RFB = window.__noVNC_RFB;
                            console.log('âœ… noVNC ä»åŠ¨æ€è„šæœ¬åŠ è½½æˆåŠŸ');
                            resolve(true);
                        }, { once: true });
                    });
                }
            }
        }

        // åˆå§‹åŒ–
        let novncLoaded = false;
        let autoConnectUrl = null;
        
        // è·å– DOM å…ƒç´ 
        const vncUrlInput = document.getElementById('vnc-url');
        const btnConnect = document.getElementById('btn-connect');
        const btnDisconnect = document.getElementById('btn-disconnect');
        const btnClear = document.getElementById('btn-clear');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const vncScreen = document.getElementById('vnc-screen');
        
        // æ£€æŸ¥ URL å‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const vncUrlFromParams = urlParams.get('url');
        if (vncUrlFromParams) {
            autoConnectUrl = decodeURIComponent(vncUrlFromParams);
            // ç«‹å³å¡«å…¥è¾“å…¥æ¡†
            vncUrlInput.value = autoConnectUrl;
            console.log('âœ… ä» URL å‚æ•°è·å– VNC URL:', autoConnectUrl.substring(0, 80) + '...');
        }
        
        // è‡ªåŠ¨è¿æ¥å‡½æ•°
        function tryAutoConnect() {
            if (novncLoaded && RFB && autoConnectUrl) {
                // ç¡®ä¿è¾“å…¥æ¡†æœ‰å€¼
                if (vncUrlInput.value !== autoConnectUrl) {
                    vncUrlInput.value = autoConnectUrl;
                }
                console.log('ğŸ”„ å°è¯•è‡ªåŠ¨è¿æ¥ VNC...');
                // å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
                setTimeout(() => {
                    connectVNC();
                    autoConnectUrl = null; // åªè‡ªåŠ¨è¿æ¥ä¸€æ¬¡
                }, 1000); // å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œç¡®ä¿ noVNC å®Œå…¨åŠ è½½
            } else if (autoConnectUrl) {
                // å¦‚æœè¿˜æ²¡å‡†å¤‡å¥½ï¼Œç»§ç»­ç­‰å¾…
                console.log('â³ ç­‰å¾… noVNC åŠ è½½å®Œæˆ...', {
                    novncLoaded,
                    hasRFB: !!RFB,
                    hasUrl: !!autoConnectUrl
                });
                setTimeout(tryAutoConnect, 500);
            }
        }
        
        loadNoVNC().then(loaded => {
            novncLoaded = loaded;
            if (!loaded) {
                document.getElementById('status-text').textContent = 'noVNC åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                document.getElementById('status-dot').classList.remove('connecting');
            } else {
                console.log('âœ… noVNC åŠ è½½å®Œæˆ');
                if (autoConnectUrl) {
                    // noVNC åŠ è½½å®Œæˆåï¼Œå°è¯•è‡ªåŠ¨è¿æ¥
                    tryAutoConnect();
                }
            }
        });


        // æ›´æ–°çŠ¶æ€
        function updateStatus(status, text) {
            statusDot.className = 'status-dot';
            if (status === 'connected') {
                statusDot.classList.add('connected');
            } else if (status === 'connecting') {
                statusDot.classList.add('connecting');
            }
            statusText.textContent = text;
        }

        // è¿æ¥ VNC
        async function connectVNC() {
            const url = vncUrlInput.value.trim();
            
            if (!url) {
                alert('è¯·è¾“å…¥ VNC URL');
                return;
            }

            if (!novncLoaded) {
                alert('noVNC å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨å€™å†è¯•');
                return;
            }

            if (!RFB) {
                alert('RFB ç±»æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            // æ¸…ç†æ—§è¿æ¥
            if (rfb) {
                try {
                    rfb.disconnect();
                } catch (e) {
                    console.error('æ–­å¼€æ—§è¿æ¥æ—¶å‡ºé”™:', e);
                }
                rfb = null;
            }

            updateStatus('connecting', 'æ­£åœ¨è¿æ¥...');
            btnConnect.disabled = true;
            btnDisconnect.disabled = false;

            try {
                // æ¸…ç©ºå±å¹•å¹¶ç¡®ä¿å®¹å™¨æ­£ç¡®
                vncScreen.innerHTML = '';
                vncScreen.style.width = '100%';
                vncScreen.style.height = '100%';
                vncScreen.style.minHeight = '600px';
                vncScreen.style.position = 'relative';
                vncScreen.style.background = '#000';
                vncScreen.style.display = 'block';

                // åˆ›å»º RFB å®ä¾‹
                console.log('ğŸ”— è¿æ¥åˆ° VNC:', url);
                console.log('ğŸ“¦ å±å¹•å…ƒç´ :', vncScreen);
                console.log('ğŸ“¦ RFB æ„é€ å‡½æ•°:', RFB);
                
                // æ£€æŸ¥ RFB æ˜¯å¦æ­£ç¡®åŠ è½½
                if (!RFB || typeof RFB !== 'function') {
                    throw new Error('RFB ç±»æœªæ­£ç¡®åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
                
                // åˆ›å»º RFB å®ä¾‹ï¼ˆnoVNC 1.4.0 çš„ APIï¼‰
                // æ³¨æ„ï¼šç¬¬äºŒä¸ªå‚æ•°æ˜¯ WebSocket URLï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯é€‰é¡¹
                rfb = new RFB(vncScreen, url, {
                    shared: true,
                    credentials: {
                        password: ''
                    }
                });
                
                console.log('âœ… RFB å®ä¾‹å·²åˆ›å»º:', rfb);

                // é…ç½® RFBï¼ˆå¿…é¡»åœ¨è¿æ¥å‰è®¾ç½®ï¼‰
                if (rfb) {
                    rfb.viewOnly = false;  // å…è®¸äº¤äº’
                    rfb.scaleViewport = true;
                    rfb.resizeSession = false;
                    rfb.showDotCursor = true;
                    rfb.background = 'rgb(0, 0, 0)';
                    
                    // ç›‘å¬è¿æ¥æˆåŠŸäº‹ä»¶
                    rfb.addEventListener('connect', (e) => {
                        console.log('âœ… VNC è¿æ¥æˆåŠŸï¼', e);
                        updateStatus('connected', 'å·²è¿æ¥');
                        
                        // ç­‰å¾…ä¸€å°æ®µæ—¶é—´åæ£€æŸ¥ Canvas
                        setTimeout(() => {
                            // æ£€æŸ¥æ˜¯å¦æœ‰ canvas å…ƒç´ 
                            const canvas = vncScreen.querySelector('canvas');
                            if (canvas) {
                                console.log('âœ… Canvas å…ƒç´ å·²åˆ›å»º:', {
                                    width: canvas.width,
                                    height: canvas.height,
                                    clientWidth: canvas.clientWidth,
                                    clientHeight: canvas.clientHeight,
                                    style: canvas.style.cssText,
                                    display: window.getComputedStyle(canvas).display,
                                    visibility: window.getComputedStyle(canvas).visibility
                                });
                                
                                // ç¡®ä¿ Canvas å¯è§
                                canvas.style.display = 'block';
                                canvas.style.visibility = 'visible';
                                
                                // å¼ºåˆ¶è§¦å‘é‡ç»˜
                                if (canvas.width > 0 && canvas.height > 0) {
                                    console.log('ğŸ“º Canvas å°ºå¯¸æ­£å¸¸ï¼Œåº”è¯¥å¼€å§‹æ¸²æŸ“');
                                } else {
                                    console.warn('âš ï¸ Canvas å°ºå¯¸ä¸º 0ï¼Œå¯èƒ½æœ‰é—®é¢˜');
                                }
                            } else {
                                console.warn('âš ï¸ æœªæ‰¾åˆ° Canvas å…ƒç´ ï¼Œæ£€æŸ¥ vncScreen å†…å®¹:', vncScreen.innerHTML);
                                
                                // å°è¯•æ‰‹åŠ¨æŸ¥æ‰¾æ‰€æœ‰ canvas
                                const allCanvases = document.querySelectorAll('canvas');
                                console.log('ğŸ” é¡µé¢ä¸­æ‰€æœ‰ Canvas å…ƒç´ :', allCanvases.length);
                                allCanvases.forEach((c, i) => {
                                    console.log(`  Canvas ${i}:`, {
                                        width: c.width,
                                        height: c.height,
                                        parent: c.parentElement?.id || c.parentElement?.tagName
                                    });
                                });
                            }
                        }, 500);
                    });
                    
                    // ç›‘å¬æ¡Œé¢åç§°äº‹ä»¶ï¼ˆè¿æ¥æˆåŠŸåä¼šè§¦å‘ï¼Œè¡¨ç¤ºæœåŠ¡å™¨å·²å‡†å¤‡å¥½ï¼‰
                    rfb.addEventListener('desktopname', (e) => {
                        console.log('ğŸ–¥ï¸ æ¡Œé¢åç§°:', e.detail?.name || e.detail);
                        console.log('ğŸ“º æ¡Œé¢ä¿¡æ¯å·²æ¥æ”¶ï¼Œå±å¹•åº”è¯¥å¼€å§‹æ¸²æŸ“');
                    });
                    
                    // ç›‘å¬æœåŠ¡å™¨èƒ½åŠ›äº‹ä»¶
                    rfb.addEventListener('capabilities', (e) => {
                        console.log('ğŸ”§ æœåŠ¡å™¨èƒ½åŠ›:', e.detail);
                    });
                    
                    // ç›‘å¬éœ€è¦å‡­æ®äº‹ä»¶
                    rfb.addEventListener('credentialsrequired', (e) => {
                        console.log('ğŸ” éœ€è¦å‡­æ®:', e.detail);
                        try {
                            rfb.sendCredentials({ password: '' });
                        } catch (err) {
                            console.warn('å‘é€å‡­æ®å¤±è´¥:', err);
                        }
                    });
                    
                    // ç›‘å¬å±å¹•æ›´æ–°äº‹ä»¶
                    rfb.addEventListener('bell', () => {
                        console.log('ğŸ”” å±å¹•æ›´æ–°äº‹ä»¶');
                    });
                }

                rfb.addEventListener('disconnect', (e) => {
                    console.log('ğŸ”Œ VNC æ–­å¼€è¿æ¥:', e.detail);
                    updateStatus('disconnected', 'å·²æ–­å¼€');
                    btnConnect.disabled = false;
                    btnDisconnect.disabled = true;
                    
                    if (!e.detail?.clean) {
                        vncScreen.innerHTML = '<div class="loading">è¿æ¥æ–­å¼€ï¼Œè¯·æ£€æŸ¥ VNC URL æ˜¯å¦æ­£ç¡®</div>';
                    }
                });

                rfb.addEventListener('securityfailure', (e) => {
                    console.error('âŒ VNC å®‰å…¨éªŒè¯å¤±è´¥:', e.detail);
                    updateStatus('error', 'å®‰å…¨éªŒè¯å¤±è´¥');
                    vncScreen.innerHTML = '<div class="loading">å®‰å…¨éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥ä¿¡æ¯</div>';
                    btnConnect.disabled = false;
                    btnDisconnect.disabled = true;
                });

            } catch (error) {
                console.error('âŒ VNC è¿æ¥å¤±è´¥:', error);
                updateStatus('error', `è¿æ¥å¤±è´¥: ${error.message}`);
                vncScreen.innerHTML = `<div class="loading">è¿æ¥å¤±è´¥: ${error.message}</div>`;
                btnConnect.disabled = false;
                btnDisconnect.disabled = true;
            }
        }

        // æ–­å¼€è¿æ¥
        function disconnectVNC() {
            if (rfb) {
                try {
                    rfb.disconnect();
                    rfb = null;
                } catch (e) {
                    console.error('æ–­å¼€è¿æ¥æ—¶å‡ºé”™:', e);
                }
            }
            updateStatus('disconnected', 'å·²æ–­å¼€');
            btnConnect.disabled = false;
            btnDisconnect.disabled = true;
            vncScreen.innerHTML = '<div class="loading">ç­‰å¾…è¿æ¥...</div>';
        }

        // æ¸…ç©ºè¾“å…¥
        function clearInput() {
            vncUrlInput.value = '';
            disconnectVNC();
        }

        // äº‹ä»¶ç»‘å®š
        btnConnect.addEventListener('click', connectVNC);
        btnDisconnect.addEventListener('click', disconnectVNC);
        btnClear.addEventListener('click', clearInput);

        // æ”¯æŒå›è½¦é”®è¿æ¥
        vncUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                connectVNC();
            }
        });

        // é¡µé¢å¸è½½æ—¶æ–­å¼€è¿æ¥
        window.addEventListener('beforeunload', () => {
            if (rfb) {
                try {
                    rfb.disconnect();
                } catch (e) {
                    console.error('é¡µé¢å¸è½½æ—¶æ–­å¼€è¿æ¥å‡ºé”™:', e);
                }
            }
        });
    </script>
</body>
</html>

